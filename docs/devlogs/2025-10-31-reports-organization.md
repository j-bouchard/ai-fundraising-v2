# DEVLOG: Report Organization & R2 Integration Strategy

**Date:** October 31, 2025
**Author:** Development Team
**Category:** Infrastructure & Data Management

---

## Overview

Implemented a structured reporting system for Goose recipe outputs with clear separation between working reports and documentation samples, designed with Cloudflare R2 deployment as the target production storage solution.

## Problem Statement

Prior to this work:
- Reports were generated ad-hoc in the repository root (e.g., `fundraising-analysis-report.md`)
- No standardized location or naming convention for report storage
- Unclear how to organize multiple reports over time
- No strategy for transitioning from local storage to cloud storage
- Git repository would bloat with large report files over time

## Solution Implemented

### Directory Structure

Created a dual-folder approach optimized for both local development and cloud deployment:

```
resin/
â”œâ”€â”€ reports/                                    # Working reports (gitignored)
â”‚   â”œâ”€â”€ .gitkeep
â”‚   â”œâ”€â”€ README.md                              # Documentation
â”‚   â””â”€â”€ fundraising-data-analysis/             # Recipe-specific folder
â”‚       â””â”€â”€ YYYY-MM-DD-HHMM/                   # Date-based organization
â”‚           â”œâ”€â”€ metadata.json                   # Execution metadata
â”‚           â””â”€â”€ report.md                       # Generated report
â”‚
â””â”€â”€ reports-sample/                             # Sample reports (committed)
    â”œâ”€â”€ README.md
    â””â”€â”€ fundraising-data-analysis/
        â””â”€â”€ 2024-10-30-1400/                   # Example with real structure
            â”œâ”€â”€ metadata.json
            â””â”€â”€ report.md
```

### Key Design Decisions

1. **Recipe-First Organization**
   - Top-level folders named after Goose recipes (`fundraising-data-analysis`)
   - Allows multiple recipes to coexist cleanly
   - Maps directly to R2 bucket organization

2. **Date-Based Subfolders**
   - Format: `YYYY-MM-DD-HHMM` (sortable, human-readable)
   - Easy to find recent reports
   - Simplifies batch operations and cleanup
   - Enables time-range queries in R2

3. **Metadata Standard**
   - Every report includes `metadata.json` with:
     - Recipe name and version
     - Execution timestamp
     - Duration and status
     - Parameters (sanitized, no secrets)
   - Enables programmatic report discovery and filtering

4. **Separation of Concerns**
   - `reports/` = gitignored working directory for active reports
   - `reports-sample/` = committed examples for documentation
   - Prevents git bloat while maintaining documentation

### Git Configuration

Updated `.gitignore` to:
```gitignore
# Reports - generated by Goose recipe runs
reports/*
!reports/.gitkeep
!reports/README.md
```

This ensures:
- Working reports never bloat the git repository
- Directory structure is preserved
- Documentation remains accessible

## Path to Cloudflare R2

### Why R2?

Cloudflare R2 provides:
- **S3-compatible API** - Standard tooling works (rclone, AWS SDK, etc.)
- **Zero egress fees** - Critical for report sharing and access
- **Global distribution** - Fast access from anywhere
- **Integration with Workers** - Can serve reports via custom domains
- **Cost-effective** - $0.015/GB storage, no bandwidth charges

### R2 Bucket Strategy

**Bucket name:** `resin-reports`

**Path structure mirrors local:**
```
Local:  reports/fundraising-data-analysis/2024-10-30-1400/report.md
R2:     s3://resin-reports/fundraising-data-analysis/2024-10-30-1400/report.md
```

This 1:1 mapping enables:
- Simple sync scripts
- Predictable URLs
- Easy migration path

### Deployment Workflow (Planned)

#### Option 1: Manual Sync (Immediate)
```bash
# Install rclone and configure R2
rclone config  # Add Cloudflare R2 remote

# Sync specific report
rclone copy reports/fundraising-data-analysis/2024-10-30-1400/ \
  r2:resin-reports/fundraising-data-analysis/2024-10-30-1400/ \
  --progress

# Sync all reports from today
rclone sync reports/ r2:resin-reports/ \
  --include "$(date +%Y-%m-%d)*/**" \
  --progress
```

#### Option 2: Wrangler CLI (Cloudflare-native)
```bash
# Upload single report
wrangler r2 object put resin-reports/fundraising-data-analysis/2024-10-30-1400/report.md \
  --file reports/fundraising-data-analysis/2024-10-30-1400/report.md

# Can be scripted for batch uploads
```

#### Option 3: Automated GitHub Action (Future)
```yaml
name: Sync Reports to R2
on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash
      - name: Configure R2
        run: |
          rclone config create r2 s3 \
            provider Cloudflare \
            access_key_id ${{ secrets.R2_ACCESS_KEY_ID }} \
            secret_access_key ${{ secrets.R2_SECRET_ACCESS_KEY }} \
            endpoint https://${{ secrets.CF_ACCOUNT_ID }}.r2.cloudflarestorage.com
      - name: Sync reports
        run: rclone sync reports/ r2:resin-reports/ --progress
```

### R2 Access Patterns

Once deployed, reports can be accessed via:

1. **Direct R2 API** (programmatic)
   ```javascript
   const report = await env.R2.get('fundraising-data-analysis/2024-10-30-1400/report.md');
   ```

2. **Public URL** (via R2 custom domain)
   ```
   https://reports.resin.example.com/fundraising-data-analysis/2024-10-30-1400/report.md
   ```

3. **Cloudflare Worker** (authentication, transformation)
   ```javascript
   // Worker can add auth, format conversion, etc.
   export default {
     async fetch(request, env) {
       const url = new URL(request.url);
       const path = url.pathname.slice(1);
       const object = await env.RESIN_REPORTS.get(path);
       return new Response(object.body);
     }
   };
   ```

## Migration Checklist

### Completed âœ…
- [x] Created `reports/` and `reports-sample/` directory structure
- [x] Added comprehensive README documentation
- [x] Configured `.gitignore` for working reports
- [x] Migrated existing `fundraising-analysis-report.md` to structured format
- [x] Created metadata.json standard
- [x] Documented R2 deployment strategy

### Next Steps ðŸ”„
- [ ] Delete legacy `fundraising-analysis-report.md` from root
- [ ] Update Goose recipe runner scripts to auto-organize reports by date
- [ ] Create R2 bucket: `resin-reports`
- [ ] Configure R2 access credentials
- [ ] Test manual sync with rclone
- [ ] Document R2 access patterns in main README
- [ ] Consider GitHub Action for automated sync

### Future Enhancements ðŸš€
- [ ] Worker-based report serving with authentication
- [ ] Report listing/discovery API
- [ ] Report versioning and diff tracking
- [ ] Automated report generation scheduling
- [ ] Report retention policies and archival
- [ ] Analytics on report access patterns

## Impact

### Immediate Benefits
- **Organization**: Clear, predictable location for all reports
- **Documentation**: Sample reports demonstrate expected format
- **Git hygiene**: Working reports don't bloat repository
- **Scalability**: Can generate unlimited reports without concern

### Future Benefits
- **Cloud storage**: Seamless transition to R2 when ready
- **Accessibility**: Reports accessible from anywhere via URL
- **Integration**: Can embed reports in dashboards, emails, etc.
- **Cost efficiency**: R2's zero egress fees enable broad sharing
- **Automation**: Foundation for scheduled report generation

## Technical Notes

### Metadata Schema
```json
{
  "recipe": "fundraising-data-analysis",
  "executed_at": "2024-10-30T14:00:00Z",
  "duration_seconds": 42,
  "goose_version": "0.9.0",
  "status": "success",
  "parameters": {
    "api_key": "[redacted]",
    "analysis_period": "2024 Full Year"
  }
}
```

### R2 Configuration (when ready)
```toml
# wrangler.toml
[[r2_buckets]]
binding = "RESIN_REPORTS"
bucket_name = "resin-reports"
```

### Cleanup Strategy
```bash
# Remove local reports older than 30 days (keep R2 as source of truth)
find reports/ -type d -name "2*" -mtime +30 -exec rm -rf {} +
```

## Lessons Learned

1. **Path structure matters**: Designing for both local and cloud from the start prevents migration pain
2. **Metadata is essential**: Makes reports discoverable and queryable
3. **Separation of working vs. samples**: Keeps git clean while maintaining documentation
4. **Date-based organization**: Simplest and most reliable for time-series data

## References

- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [Goose Recipe Documentation](https://github.com/block/goose)
- [Keep a Changelog](https://keepachangelog.com/) - Inspired our documentation approach
- [12-Factor App: Backing Services](https://12factor.net/backing-services) - Treat storage as attached resource

---

**Status:** âœ… Complete - Ready for R2 deployment when needed
**Next Review:** When creating second recipe that generates reports
